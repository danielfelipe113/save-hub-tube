<template>
		<main>
			
			<section class="container px-4 lg:pt-24 lg:pb-64 pt-10 pb-20 relative block ">
				<div class=" mx-auto ">
					<div class="flex flex-wrap text-center justify-center">
						<div class="mt-2 mb-6">
							<svg width="429" height="95.11395697848924" viewBox="0 0 370.1851851851852 82.07407407407408" class="css-1j8o68f"><defs id="SvgjsDefs1236"></defs><g id="SvgjsG1237" featurekey="HKaMnE-0" transform="matrix(0.14467592592592593,0,0,0.14467592592592593,1.3703703703703702,8)" fill="#ffe239"><path xmlns="http://www.w3.org/2000/svg" fill-rule="evenodd" clip-rule="evenodd" d="M452.305,306.484L153.883,486.5c-2.73,2.156-6.137,3.5-9.887,3.5  c-8.844,0-16.004-7.156-16.004-16c0-6.047,3.43-11.25,8.379-13.977l299.355-181.977c1.617-1.039,3.211-2.219,4.648-3.656  c10.156-10.156,10.156-26.625,0-36.777c-1.578-1.578-3.32-2.871-5.172-3.984L109.195,35.473c-4.254-2.191-9.043-3.465-14.137-3.465  c-17.152,0-31.07,13.906-31.07,31.055V408c0,8.844-7.16,16-16.004,16C39.156,424,32,416.844,32,408V62.379  C32,27.938,59.914,0,94.375,0c11.305,0,21.852,3.074,31,8.328l326.797,197.121C468.875,216.086,480,234.723,480,256  C480,277.219,468.938,295.812,452.305,306.484L452.305,306.484z M79.988,480.016c8.844,0,16,7.156,16,16  c0,8.828-7.156,15.984-16,15.984c-8.824,0-16-7.156-16-15.984C63.988,487.172,71.164,480.016,79.988,480.016L79.988,480.016z"></path></g><g id="SvgjsG1238" featurekey="J3GnXt-0" transform="matrix(2.314063392353581,0,0,2.314063392353581,83.4727196175761,18.707370380490985)" fill="#ffffff"><path d="M5.88 5.48 c1.84 0 3.2 0.54006 4.08 1.6201 l-1.56 1.42 c-0.24 -0.37334 -0.58 -0.67334 -1.02 -0.9 s-0.94666 -0.34 -1.52 -0.34 c-0.82666 0 -1.49 0.20334 -1.99 0.61 s-0.75 0.93 -0.75 1.57 c0 1.0667 0.70666 1.8133 2.12 2.24 l1.78 0.58 c1 0.32 1.7633 0.76666 2.29 1.34 s0.79 1.36 0.79 2.36 c0 1.3067 -0.46334 2.3634 -1.39 3.17 s-2.1034 1.21 -3.53 1.21 c-2.04 0 -3.5466 -0.65334 -4.52 -1.96 l1.58 -1.36 c0.30666 0.48 0.72666 0.85334 1.26 1.12 s1.1133 0.4 1.74 0.4 c0.78666 0 1.4533 -0.22666 2 -0.68 s0.82 -1.0133 0.82 -1.68 c0 -0.49334 -0.16666 -0.90668 -0.5 -1.24 s-0.93334 -0.63334 -1.8 -0.9 l-1.26 -0.42 c-1.2667 -0.42666 -2.1534 -0.97 -2.66 -1.63 s-0.76 -1.51 -0.76 -2.55 c0 -1.1067 0.44666 -2.0466 1.34 -2.82 s2.0466 -1.16 3.46 -1.16 z M16.28 10.28 c1.2 0 2.15 0.27328 2.85 0.81994 s1.07 1.3067 1.11 2.28 l0 5.08 c0 0.48 0.02666 0.99334 0.08 1.54 l-1.6 0 c-0.04 -0.42666 -0.06 -0.90666 -0.06 -1.44 l-0.04 0 c-0.41334 0.61334 -0.89 1.0467 -1.43 1.3 s-1.17 0.38 -1.89 0.38 c-0.97334 0 -1.7633 -0.26 -2.37 -0.78 s-0.91 -1.2067 -0.91 -2.06 c0 -1.08 0.45334 -1.8967 1.36 -2.45 s2.1866 -0.83 3.84 -0.83 l1.34 0 l0 -0.34 c0 -0.64 -0.21 -1.1433 -0.63 -1.51 s-0.97 -0.55 -1.65 -0.55 c-0.50666 0 -0.95 0.07666 -1.33 0.23 s-0.83 0.43668 -1.35 0.85002 l-1.08 -1.12 c1.0267 -0.90666 2.28 -1.3733 3.76 -1.4 z M13.82 17.259999999999998 c0 1.0267 0.68002 1.54 2.04 1.54 c0.81334 0 1.4633 -0.24334 1.95 -0.73 s0.73666 -1.19 0.75 -2.11 l0 -0.52 l-1.02 0 c-1.1733 0 -2.0866 0.15 -2.74 0.45 s-0.98 0.75666 -0.98 1.37 z M23.8 10.52 l2.84 7.26 l2.72 -7.26 l1.92 0 l-3.72 9.48 l-1.98 0 l-3.86 -9.48 l2.08 0 z M37.2 10.28 c1.4533 0 2.5834 0.45664 3.39 1.37 s1.2167 2.17 1.23 3.77 l0 0.5 l-7.6 0 c0 0.77334 0.31 1.4233 0.93 1.95 s1.3767 0.79666 2.27 0.81 c0.98666 0 1.8533 -0.47334 2.6 -1.42 l1.36 1.04 c-1.0133 1.2933 -2.4134 1.94 -4.2 1.94 c-1.4533 0 -2.6234 -0.46334 -3.51 -1.39 s-1.3433 -2.1234 -1.37 -3.59 c0 -1.4133 0.45666 -2.59 1.37 -3.53 s2.09 -1.4233 3.53 -1.45 z M39.9 14.48 c-0.02666 -0.89334 -0.28 -1.5767 -0.76 -2.05 s-1.14 -0.71 -1.98 -0.71 c-0.56 0 -1.0633 0.13666 -1.51 0.41 s-0.79666 0.62668 -1.05 1.06 s-0.38 0.86334 -0.38 1.29 l5.68 0 z M46.36000000000001 5.84 l0 5.88 l7.34 0 l0 -5.88 l1.92 0 l0 14.16 l-1.92 0 l0 -6.48 l-7.34 0 l0 6.48 l-1.92 0 l0 -14.16 l1.92 0 z M60.60000000000001 10.52 l0 5.68 c0 0.74666 0.19666 1.3267 0.59 1.74 s0.91668 0.62 1.57 0.62 c0.84 0 1.49 -0.27666 1.95 -0.83 s0.69 -1.3033 0.69 -2.25 l0 -4.96 l1.8 0 l0 9.48 l-1.8 0 l0 -1.46 l-0.04 0 c-0.25334 0.53334 -0.66668 0.95 -1.24 1.25 s-1.2 0.45 -1.88 0.45 c-1.0533 0 -1.89 -0.32666 -2.51 -0.98 s-0.93 -1.5067 -0.93 -2.56 l0 -6.18 l1.8 0 z M71.72 4.880000000000001 l0.000019531 7 l0.04 0 c0.32 -0.49334 0.78334 -0.88334 1.39 -1.17 s1.2433 -0.43 1.91 -0.43 c1.4267 0 2.5866 0.47 3.48 1.41 s1.34 2.13 1.34 3.57 c0 1.4267 -0.43666 2.6066 -1.31 3.54 s-2.0366 1.4133 -3.49 1.44 c-0.65334 0 -1.2833 -0.14 -1.89 -0.42 s-1.0833 -0.67334 -1.43 -1.18 l-0.04 0 l0 1.36 l-1.8 0 l0 -15.12 l1.8 0 z M71.72 15.26 c0 0.98666 0.28338 1.7767 0.85004 2.37 s1.3233 0.90334 2.27 0.93 c0.94666 0 1.7033 -0.30666 2.27 -0.92 s0.85 -1.4067 0.85 -2.38 s-0.28 -1.7633 -0.84 -2.37 s-1.3267 -0.91666 -2.3 -0.93 c-0.94666 0 -1.7 0.31 -2.26 0.93 s-0.84 1.41 -0.84 2.37 z M92.04 5.84 l0 1.8 l-4.56 0 l0 12.36 l-1.92 0 l0 -12.36 l-4.56 0 l0 -1.8 l11.04 0 z M93.4 10.52 l0 5.68 c0 0.74666 0.19666 1.3267 0.59 1.74 s0.91668 0.62 1.57 0.62 c0.84 0 1.49 -0.27666 1.95 -0.83 s0.69 -1.3033 0.69 -2.25 l0 -4.96 l1.8 0 l0 9.48 l-1.8 0 l0 -1.46 l-0.04 0 c-0.25334 0.53334 -0.66668 0.95 -1.24 1.25 s-1.2 0.45 -1.88 0.45 c-1.0533 0 -1.89 -0.32666 -2.51 -0.98 s-0.93 -1.5067 -0.93 -2.56 l0 -6.18 l1.8 0 z M104.52000000000001 4.880000000000001 l0.000019531 7 l0.04 0 c0.32 -0.49334 0.78334 -0.88334 1.39 -1.17 s1.2433 -0.43 1.91 -0.43 c1.4267 0 2.5866 0.47 3.48 1.41 s1.34 2.13 1.34 3.57 c0 1.4267 -0.43666 2.6066 -1.31 3.54 s-2.0366 1.4133 -3.49 1.44 c-0.65334 0 -1.2833 -0.14 -1.89 -0.42 s-1.0833 -0.67334 -1.43 -1.18 l-0.04 0 l0 1.36 l-1.8 0 l0 -15.12 l1.8 0 z M104.52000000000001 15.26 c0 0.98666 0.28338 1.7767 0.85004 2.37 s1.3233 0.90334 2.27 0.93 c0.94666 0 1.7033 -0.30666 2.27 -0.92 s0.85 -1.4067 0.85 -2.38 s-0.28 -1.7633 -0.84 -2.37 s-1.3267 -0.91666 -2.3 -0.93 c-0.94666 0 -1.7 0.31 -2.26 0.93 s-0.84 1.41 -0.84 2.37 z M119.28000000000002 10.28 c1.4533 0 2.5834 0.45664 3.39 1.37 s1.2167 2.17 1.23 3.77 l0 0.5 l-7.6 0 c0 0.77334 0.31 1.4233 0.93 1.95 s1.3767 0.79666 2.27 0.81 c0.98666 0 1.8533 -0.47334 2.6 -1.42 l1.36 1.04 c-1.0133 1.2933 -2.4134 1.94 -4.2 1.94 c-1.4533 0 -2.6234 -0.46334 -3.51 -1.39 s-1.3433 -2.1234 -1.37 -3.59 c0 -1.4133 0.45666 -2.59 1.37 -3.53 s2.09 -1.4233 3.53 -1.45 z M121.98000000000002 14.48 c-0.02666 -0.89334 -0.28 -1.5767 -0.76 -2.05 s-1.14 -0.71 -1.98 -0.71 c-0.56 0 -1.0633 0.13666 -1.51 0.41 s-0.79666 0.62668 -1.05 1.06 s-0.38 0.86334 -0.38 1.29 l5.68 0 z"></path></g></svg>
						</div>
						<div class="w-full lg:w-6/12 px-4">
							<!-- <h2 class="text-4xl font-semibold text-white">Youtube Downloader</h2> -->
							<p class="text-lg leading-relaxed mt-4 mb-10 text-gray-200 ">
								Enter one or more YouTube URLs, separated by semicolons (;), then click the 'Download Now' button
							</p>
						</div>
					</div>
					<div class="px-4">
						<div class="indicator w-full">
							<button class="indicator-item badge badge-primary" @click.prevent="urlsString = ''" v-if="urlsString">Clear</button>
							<!-- <span class="indicator-item badge badge-primary">
							</span>  -->
							<textarea class="w-full textarea textarea-primary" rows="5" v-model="urlsString"></textarea>
						</div>
					</div>
					<div class="flex justify-center mt-6">
						<button class="btn btn-neutral" @click.prevent="addToQueue">Add to queue</button>
					</div>

					<div v-if="globalStore.candidatesLength">
						<div class="flex justify-between items-end">
							<span>
								{{ infoLabel }}
							</span>
							<button class="btn btn-primary mt-10" @click.prevent="globalStore.downloadAll">
								<span class="loading loading-spinner loading-xs" v-if="globalStore.candidatesBeingDownloaded.length || globalStore.candidatesDetailsBeingFetched.length"></span>
								{{ downloadButtonText }}
							</button>
						</div>
						
						<DownloadCandidates />
					</div>
				</div>
			</section>
		</main>
		
</template>
<script setup lang="ts">
import { computed, onMounted, ref } from 'vue'
import { v4 as uuidv4 } from 'uuid';
import { CandidateModel } from '@/models/Candidate.model';
import { useGlobalStore } from '@/store/store'
import { toast } from 'vue3-toastify';
import DownloadCandidates from './DownloadCandidates.vue';



const globalStore = useGlobalStore();
// const urlsString = ref('https://www.youtube.com/watch?v=an60NyBayzE&t=4957s;https://www.youtube.com/watch?v=gutCDxJU6gM');
// const urlsString = ref('https://www.youtube.com/watch?v=gutCDxJU6gM');
const urlsString = ref('');

const infoLabel = computed(() => {
	if(globalStore.candidatesPending.length) {
		return `${globalStore.candidatesPending.length} file${globalStore.candidatesPending.length > 1 ? 's' : ''} being verificated.`
	}
	if(globalStore.successfulDownloaded.length || globalStore.failedDownloaded.length) {
		return `Downloaded ${globalStore.successfulDownloaded.length} file${globalStore.successfulDownloaded.length > 1 ? 's' : ''}. ${globalStore.failedDownloaded.length} Failed.`
	}
	return `${globalStore.candidatesLength} files in queue.`
});

const downloadButtonText = computed(() => {
	if(globalStore.candidatesDetailsBeingFetched.length) {
		return 'Fetching...'
	}
	if(globalStore.candidatesBeingDownloaded.length) {
		return 'Downloading...'
	}
	return 'Download Now'
})

onMounted(() => {
	globalStore.showToast('Welcome to Youtube Downloader');

	
})


function addToQueue() {
	const urlArray = urlsString.value.split(';').filter(Boolean);

	let warningMessages: string[] = [];
	
	if(!urlArray.length) {
		warningMessages.push('No URLs were added.');
	}

	urlArray.forEach(url => {
		const trimmedUrlString = url.trim();
		const urlObj = new URL(trimmedUrlString);
		if (globalStore.approvedDomains.includes(urlObj.host.replace(/^www\./gui, ''))) {
			// Find duplicates
			const duplicate = Object.values(globalStore.downloadCandidates).find((download: CandidateModel) => download.url === urlObj.href);
			if(duplicate) {
				warningMessages.push(`Duplicate URL: ${urlObj.href}`);
			} else {
				const newCandidate = new CandidateModel(
					uuidv4(),
					urlObj.href,
				);

				globalStore.downloadCandidates[newCandidate.id] = newCandidate;
				globalStore.fetchFileDetailsWithoutDownload(newCandidate);
			}
		} else {
			warningMessages.push('Invalid or malformed URLs were not added.');
		}
	});

	if(warningMessages.length) {
		warningMessages.forEach(warningMessage => {
			globalStore.showToast(warningMessage, toast.TYPE.WARNING);
		})
	}
}

</script>
@/models/Candidate.model